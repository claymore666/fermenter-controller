; PlatformIO Project Configuration File
; Fermentation Controller - ESP32-S3

[platformio]
default_envs = esp32
; Use all available cores for parallel compilation
jobs = 32

; Common settings
[env]
monitor_speed = 115200
test_framework = unity
build_flags =
    -std=gnu++17
    -Wall
    -Wextra

; ESP32 common settings - version extracted from version.h
[esp32_common]
extra_scripts = pre:scripts/extract_version.py

; =============================================================================
; Native test environment (Tier 1 - Unit Tests)
; =============================================================================
[env:native_test]
platform = native
build_flags =
    ${env.build_flags}
    -DUNIT_TEST
    -DNATIVE_BUILD
    -I include
test_build_src = yes
lib_deps =
    throwtheswitch/Unity @ ^2.6.0
    bblanchon/ArduinoJson @ ^7.0.0

; =============================================================================
; Simulator environment (Tier 2 - Integration Tests)
; =============================================================================
[env:simulator]
platform = native
build_flags =
    ${env.build_flags}
    -DSIMULATOR_BUILD
    -DHAL_SIMULATOR
    -DDEBUG_CONSOLE_ENABLED
    -I include
test_build_src = yes
test_ignore = test_web_server
lib_deps =
    ArduinoJson @ ^7.0.0

; =============================================================================
; ESP32-S3 target (Tier 3 - Hardware)
; =============================================================================
[env:esp32]
extends = esp32_common
platform = espressif32
board = esp32-s3-devkitc-1
framework = espidf
board_build.flash_size = 16MB
board_upload.flash_size = 16MB
board_build.partitions = partitions.csv
board_build.f_flash = 80000000L
build_flags =
    ${env.build_flags}
    -DESP32_BUILD
    -DHAL_ESP32
    -DDEBUG_CONSOLE_ENABLED
    -DDEBUG_BAUD=115200
    -I include
lib_deps =
    bblanchon/ArduinoJson @ ^7.0.0
upload_protocol = esptool
monitor_filters =
    esp32_exception_decoder
    time

; =============================================================================
; ESP32-S3 with WiFi + NTP + HTTP server
; =============================================================================
[env:esp32_wifi]
extends = esp32_common
platform = espressif32
board = esp32-s3-devkitc-1
framework = espidf
board_build.flash_size = 16MB
board_upload.flash_size = 16MB
board_build.partitions = partitions.csv
board_build.f_flash = 80000000L
board_build.filesystem = spiffs
build_flags =
    ${env.build_flags}
    -DESP32_BUILD
    -DHAL_ESP32
    -DDEBUG_CONSOLE_ENABLED
    -DDEBUG_BAUD=115200
    -DWIFI_NTP_ENABLED
    -DETHERNET_ENABLED
    -DHTTP_ENABLED
    -DCAN_ENABLED
    -DCERT_GENERATION_ENABLED
    -DWEBSOCKET_ENABLED
    -DOTA_ENABLED
    -I include
    -I components/mdns/include
lib_deps =
    bblanchon/ArduinoJson @ ^7.0.0
; mDNS component cloned from https://github.com/espressif/esp-protocols
; Per-device SSL certificate generation enabled via CERT_GENERATION_ENABLED
; board_build.embed_txtfiles =
;     certs/server.crt
;     certs/server.key
upload_protocol = esptool
monitor_filters =
    esp32_exception_decoder
    time

; =============================================================================
; ESP32-S3 full build (WiFi + NTP + HTTP + MQTT)
; =============================================================================
[env:esp32_full]
extends = esp32_common
platform = espressif32
board = esp32-s3-devkitc-1
framework = espidf
build_flags =
    ${env.build_flags}
    -DESP32_BUILD
    -DHAL_ESP32
    -DDEBUG_CONSOLE_ENABLED
    -DDEBUG_BAUD=115200
    -DWIFI_NTP_ENABLED
    -DCAN_ENABLED
    -DHTTP_ENABLED
    -DMQTT_ENABLED
    -DWEBSOCKET_ENABLED
    -DOTA_ENABLED
    -I include
lib_deps =
    bblanchon/ArduinoJson @ ^7.0.0
upload_protocol = esptool
monitor_filters =
    esp32_exception_decoder
    time
